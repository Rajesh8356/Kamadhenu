<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Appointment - Kamadhenu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-green: #043c07;
            --pastoral-green: #406515;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Nunito', sans-serif;
        }
        .header-card {
            background: linear-gradient(135deg, var(--primary-green), var(--pastoral-green));
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background-color: var(--primary-green);
            border: none;
        }
        .btn-primary:hover {
            background-color: var(--pastoral-green);
        }
        .animal-treatment-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fafafa;
        }
        .add-animal-btn {
            background-color: var(--pastoral-green);
            color: white;
            border: none;
        }
        .remove-animal-btn {
            background-color: #dc3545;
            color: white;
            border: none;
        }
         /* Language Selector Styles - BOTTOM */
    .language-selector {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        background: white;
        padding: 10px 15px;
        border-radius: 25px;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
        display: flex;
        gap: 10px;
        border: 2px solid #27ae60;
    }

    .lang-btn {
        padding: 8px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .lang-btn.english {
        background: #007bff;
        color: white;
    }

    .lang-btn.kannada {
        background: #ff9800;
        color: white;
    }

    .lang-btn.active {
        transform: scale(1.05);
        box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
    }

    /* Hide Google banner */
    .goog-te-banner-frame { display: none !important; }
    body { top: 0 !important; }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .language-selector {
            bottom: 10px;
            right: 10px;
            padding: 6px 10px;
        }
        
        .lang-btn {
            padding: 5px 10px;
            font-size: 12px;
        }
    }
    /* Completely hide ALL Google Translate elements */
    .goog-te-banner-frame,
    .goog-te-banner,
    .goog-te-banner-wrapper,
    .skiptranslate,
    #goog-gt-tt,
    .goog-te-balloon-frame,
    .goog-tooltip,
    .goog-tooltip:hover,
    .goog-text-highlight {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        width: 0 !important;
        position: absolute !important;
    }
    
    /* Prevent body shift */
    body {
        top: 0px !important;
        position: static !important;
    }
    
    /* Hide the translation menu if it appears */
    .goog-te-menu-frame {
        display: none !important;
    }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="header-card">
            <h4><i class="fas fa-stethoscope me-2"></i> Complete Appointment</h4>
            <p class="mb-0">Record treatment details for {{ appointment['farmer_name'] }} - You can treat multiple animals</p>
        </div>

        <div class="card form-card">
            <div class="card-header">
                <h5 class="mb-0">Treatment Details for Multiple Animals</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('save_treatment') }}" method="POST" id="treatmentForm">
                    <input type="hidden" name="appointment_id" value="{{ appointment['id'] }}">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Appointment Date</label>
                            <input type="text" class="form-control" value="{{ appointment['date'] }} {{ appointment['time'] }}" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Farmer</label>
                            <input type="text" class="form-control" value="{{ appointment['farmer_name'] }}" readonly>
                        </div>
                    </div>

                    <!-- Animal Treatments Container -->
                    <div id="animalTreatmentsContainer">
                        <!-- First animal treatment section -->
                        <div class="animal-treatment-section" id="animalSection1">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Animal 1 Treatment Details</h6>
                                <button type="button" class="btn remove-animal-btn btn-sm" onclick="removeAnimalSection(1)" id="removeBtn1" style="display: none;">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Select Cow *</label>
                                    <select name="cow_id[]" class="form-select" required>
                                        <option value="">Choose a cow...</option>
                                        {% for cow in cows %}
                                        <option value="{{ cow['cow_id'] }}">
                                            {{ cow['breed'] }} (Age: {{ cow['age'] }} years)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Current Vaccination History</label>
                                    <textarea class="form-control" rows="2" readonly>
                                        {% for cow in cows %}{% if loop.first %}{{ cow['vaccination_history'] or 'No vaccination history' }}{% endif %}{% endfor %}
                                    </textarea>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Diagnosis *</label>
                                <textarea name="diagnosis[]" class="form-control" rows="2" 
                                          placeholder="Enter diagnosis details for this animal..." required></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Medicines Prescribed *</label>
                                <textarea name="medicines[]" class="form-control" rows="2" 
                                          placeholder="List all medicines with dosage for this animal..." required></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Vaccination Details (if any)</label>
                                <textarea name="vaccination_details[]" class="form-control" rows="2" 
                                          placeholder="Enter vaccination details for this animal..."></textarea>
                                <div class="form-text">This will be automatically added to this cow's vaccination history.</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Special Instructions</label>
                                <textarea name="instructions[]" class="form-control" rows="2" 
                                          placeholder="Any special instructions for this animal..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Add Another Animal Button -->
                    <div class="mb-4">
                        <button type="button" class="btn add-animal-btn" onclick="addAnimalSection()">
                            <i class="fas fa-plus me-1"></i> Add Another Animal
                        </button>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('vet_appointments') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Appointments
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-1"></i> Complete All Treatments
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let animalCounter = 1;
        const cows = {{ cows | tojson }};

        function addAnimalSection() {
            animalCounter++;
            const newSection = document.createElement('div');
            newSection.className = 'animal-treatment-section';
            newSection.id = 'animalSection' + animalCounter;
            
            newSection.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Animal ${animalCounter} Treatment Details</h6>
                    <button type="button" class="btn remove-animal-btn btn-sm" onclick="removeAnimalSection(${animalCounter})">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Select Cow *</label>
                        <select name="cow_id[]" class="form-select" required onchange="updateVaccinationHistory(this, ${animalCounter})">
                            <option value="">Choose a cow...</option>
                            ${cows.map(cow => `
                                <option value="${cow.cow_id}">
                                    ${cow.breed} (Age: ${cow.age} years)
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Current Vaccination History</label>
                        <textarea class="form-control vaccination-history" id="vaccinationHistory${animalCounter}" rows="2" readonly>Select a cow to see vaccination history</textarea>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Diagnosis *</label>
                    <textarea name="diagnosis[]" class="form-control" rows="2" 
                              placeholder="Enter diagnosis details for this animal..." required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Medicines Prescribed *</label>
                    <textarea name="medicines[]" class="form-control" rows="2" 
                              placeholder="List all medicines with dosage for this animal..." required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Vaccination Details (if any)</label>
                    <textarea name="vaccination_details[]" class="form-control" rows="2" 
                              placeholder="Enter vaccination details for this animal..."></textarea>
                    <div class="form-text">This will be automatically added to this cow's vaccination history.</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Special Instructions</label>
                    <textarea name="instructions[]" class="form-control" rows="2" 
                              placeholder="Any special instructions for this animal..."></textarea>
                </div>
            `;
            
            document.getElementById('animalTreatmentsContainer').appendChild(newSection);
        }

        function removeAnimalSection(sectionId) {
            const section = document.getElementById('animalSection' + sectionId);
            if (section) {
                section.remove();
            }
        }

        function updateVaccinationHistory(selectElement, sectionId) {
            const selectedCowId = selectElement.value;
            const vaccinationHistoryField = document.getElementById('vaccinationHistory' + sectionId);
            
            if (selectedCowId) {
                const selectedCow = cows.find(cow => cow.cow_id === selectedCowId);
                if (selectedCow && selectedCow.vaccination_history) {
                    vaccinationHistoryField.value = selectedCow.vaccination_history;
                } else {
                    vaccinationHistoryField.value = 'No vaccination history recorded';
                }
            } else {
                vaccinationHistoryField.value = 'Select a cow to see vaccination history';
            }
        }

        // Initialize vaccination history for first animal
        document.addEventListener('DOMContentLoaded', function() {
            const firstSelect = document.querySelector('select[name="cow_id[]"]');
            if (firstSelect) {
                firstSelect.addEventListener('change', function() {
                    updateVaccinationHistory(this, 1);
                });
            }
        });
    </script>
    <script>
    // Language translation functions
    function googleTranslateElementInit() {
        if (typeof google !== 'undefined' && google.translate) {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,kn',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
            
            const savedLang = localStorage.getItem('selectedLanguage');
            if(savedLang === 'kn') {
                setTimeout(() => applyKannada(), 1000);
            }
        }
    }

    window.onload = function() {
        if (typeof google !== 'undefined' && google.translate) {
            googleTranslateElementInit();
        } else {
            var script = document.createElement('script');
            script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
            document.body.appendChild(script);
        }
        
        const savedLang = localStorage.getItem('selectedLanguage');
        if(savedLang === 'kn') {
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.lang-btn.kannada').classList.add('active');
            setTimeout(() => applyKannada(), 2000);
        }
    };

    function applyKannada() {
        var iframe = document.querySelector('.goog-te-menu-frame');
        if(iframe && iframe.contentDocument) {
            var select = iframe.contentDocument.querySelector('.goog-te-menu2-select');
            if(select) {
                select.value = 'kn';
                select.dispatchEvent(new Event('change'));
                return true;
            }
        }
        
        var elements = document.querySelectorAll('.goog-te-menu2-select');
        if(elements.length > 0) {
            elements[0].value = 'kn';
            elements[0].dispatchEvent(new Event('change'));
            return true;
        }
        
        return false;
    }

    function setLanguage(lang) {
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        localStorage.setItem('selectedLanguage', lang);
        
        if(lang === 'kn') {
            window.location.hash = '#googtrans(kn)';
            if(applyKannada()) {
                console.log('ಭಾಷೆ ಕನ್ನಡಕ್ಕೆ ಬದಲಾಯಿಸಲಾಗಿದೆ');
            } else {
                setTimeout(() => location.reload(), 500);
            }
        } else {
            window.location.hash = '#googtrans(en)';
            var iframe = document.querySelector('.goog-te-menu-frame');
            if(iframe && iframe.contentDocument) {
                var select = iframe.contentDocument.querySelector('.goog-te-menu2-select');
                if(select) {
                    select.value = 'en';
                    select.dispatchEvent(new Event('change'));
                    console.log('Language changed to English');
                    return;
                }
            }
            setTimeout(() => location.reload(), 500);
        }
    }
</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>